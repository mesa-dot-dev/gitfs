name: Promote to Latest

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: promote-to-latest
  cancel-in-progress: false

jobs:
  promote:
    name: Promote canary to latest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find latest canary release
        id: canary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the most recent canary release
          CANARY_TAG=$(gh release list \
            --limit 100 \
            --exclude-drafts \
            --json tagName,isPrerelease,createdAt \
            --jq '[.[] | select(.tagName | startswith("canary-")) | select(.isPrerelease)] | sort_by(.createdAt) | last | .tagName')

          if [ -z "${CANARY_TAG}" ] || [ "${CANARY_TAG}" = "null" ]; then
            echo "::error::No canary release found"
            exit 1
          fi

          echo "Found canary release: ${CANARY_TAG}"
          echo "tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

          # Extract the version from the release title (e.g. "git-fs 0.1.0+024e288 (canary)")
          VERSION=$(gh release view "${CANARY_TAG}" --json name --jq '.name' \
            | sed 's/^git-fs //' | sed 's/ (canary)$//')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          # Get the target commit SHA
          TARGET=$(gh release view "${CANARY_TAG}" --json targetCommitish --jq '.targetCommitish')
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"

      - name: Download canary assets
        env:
          GH_TOKEN: ${{ github.token }}
          CANARY_TAG: ${{ steps.canary.outputs.tag }}
        run: |
          mkdir -p assets
          gh release download "${CANARY_TAG}" --dir assets
          echo "Downloaded assets:"
          ls -la assets/

      - name: Rename assets to stable paths
        run: |
          cd assets
          for f in git-fs_*.deb; do
            # e.g. git-fs_ubuntu-24.04_0.1.1-alpha+abc1234_arm64.deb → git-fs_ubuntu-24.04_arm64.deb
            stable=$(echo "$f" | sed -E 's/git-fs_([^_]+)_[^_]+_([^.]+)\.deb/git-fs_\1_\2.deb/')
            [ "$f" != "$stable" ] && mv "$f" "$stable"
          done
          for f in git-fs_*.rpm; do
            # e.g. git-fs_rocky-8_0.1.0+abc1234-1.x86_64.rpm → git-fs_rocky-8.x86_64.rpm
            stable=$(echo "$f" | sed -E 's/git-fs_([^_]+)_.+\.(x86_64|aarch64)\.rpm/git-fs_\1.\2.rpm/')
            [ "$f" != "$stable" ] && mv "$f" "$stable"
          done
          echo "Renamed assets:"
          ls -la

      - name: Delete existing latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view latest &>/dev/null; then
            echo "Deleting existing 'latest' release..."
            gh release delete latest --yes --cleanup-tag
          else
            echo "No existing 'latest' release found, skipping."
          fi

      - name: Create latest release
        env:
          GH_TOKEN: ${{ github.token }}
          CANARY_TAG: ${{ steps.canary.outputs.tag }}
          VERSION: ${{ steps.canary.outputs.version }}
          TARGET: ${{ steps.canary.outputs.target }}
        run: |
          gh release create latest \
            --title "git-fs ${VERSION}" \
            --notes "Stable release of git-fs ${VERSION}.

          Promoted from canary release [\`${CANARY_TAG}\`](https://github.com/${{ github.repository }}/releases/tag/${CANARY_TAG})." \
            --target "${TARGET}" \
            --latest \
            assets/*
