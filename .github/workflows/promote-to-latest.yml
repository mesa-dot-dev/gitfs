name: Promote to Latest

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-pipeline
  cancel-in-progress: false

jobs:
  promote:
    name: Promote canary to latest
    runs-on: blacksmith-2vcpu-ubuntu-2404
    outputs:
      version: ${{ steps.canary.outputs.version }}
      base_version: ${{ steps.canary.outputs.base_version }}
      tag: ${{ steps.canary.outputs.tag }}
      target: ${{ steps.canary.outputs.target }}
    steps:
      - uses: actions/checkout@v4

      - name: Find latest canary release
        id: canary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the most recent canary release
          CANARY_TAG=$(gh release list \
            --limit 100 \
            --exclude-drafts \
            --json tagName,isPrerelease,createdAt \
            --jq '[.[] | select(.tagName | startswith("canary-")) | select(.isPrerelease)] | sort_by(.createdAt) | last | .tagName')

          if [ -z "${CANARY_TAG}" ] || [ "${CANARY_TAG}" = "null" ]; then
            echo "::error::No canary release found"
            exit 1
          fi

          echo "Found canary release: ${CANARY_TAG}"
          echo "tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

          # Extract the version from the release title (e.g. "git-fs 0.1.0+024e288 (canary)")
          VERSION=$(gh release view "${CANARY_TAG}" --json name --jq '.name' \
            | sed 's/^git-fs //' | sed 's/ (canary)$//')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          BASE_VERSION=$(echo "${VERSION}" | sed 's/+.*//')
          echo "base_version=${BASE_VERSION}" >> "$GITHUB_OUTPUT"

          # Get the target commit SHA
          TARGET=$(gh release view "${CANARY_TAG}" --json targetCommitish --jq '.targetCommitish')
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"

      - name: Download canary assets
        env:
          GH_TOKEN: ${{ github.token }}
          CANARY_TAG: ${{ steps.canary.outputs.tag }}
        run: |
          mkdir -p assets
          gh release download "${CANARY_TAG}" --dir assets
          echo "Downloaded assets:"
          ls -la assets/

      - name: Rename assets to stable paths
        run: |
          cd assets
          for f in git-fs_*.deb; do
            # e.g. git-fs_ubuntu-24.04_0.1.1-alpha+abc1234_arm64.deb → git-fs_ubuntu-24.04_arm64.deb
            stable=$(echo "$f" | sed -E 's/git-fs_([^_]+)_[^_]+_([^.]+)\.deb/git-fs_\1_\2.deb/')
            [ "$f" != "$stable" ] && mv "$f" "$stable"
          done
          for f in git-fs_*.rpm; do
            # e.g. git-fs_rocky-8_0.1.0+abc1234-1.x86_64.rpm → git-fs_rocky-8.x86_64.rpm
            stable=$(echo "$f" | sed -E 's/git-fs_([^_]+)_.+\.(x86_64|aarch64)\.rpm/git-fs_\1.\2.rpm/')
            [ "$f" != "$stable" ] && mv "$f" "$stable"
          done
          echo "Renamed assets:"
          ls -la

      - name: Delete existing latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view latest &>/dev/null; then
            echo "Deleting existing 'latest' release..."
            gh release delete latest --yes
          else
            echo "No existing 'latest' release found, skipping."
          fi
          if git ls-remote --tags origin latest | grep -q latest; then
            echo "Deleting existing 'latest' tag..."
            git push origin :refs/tags/latest
          fi

      - name: Create latest release
        env:
          GH_TOKEN: ${{ github.token }}
          CANARY_TAG: ${{ steps.canary.outputs.tag }}
          VERSION: ${{ steps.canary.outputs.version }}
          TARGET: ${{ steps.canary.outputs.target }}
        run: |
          gh release create latest \
            --title "git-fs ${VERSION}" \
            --notes "Stable release of git-fs ${VERSION}.

          Promoted from canary release [\`${CANARY_TAG}\`](https://github.com/${{ github.repository }}/releases/tag/${CANARY_TAG})." \
            --target "${TARGET}" \
            --latest \
            assets/*

      - name: Create versioned release
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_VERSION: ${{ steps.canary.outputs.base_version }}
          TARGET: ${{ steps.canary.outputs.target }}
        run: |
          TAG="v${BASE_VERSION}"
          if gh release view "${TAG}" &>/dev/null; then
            echo "Release ${TAG} already exists, skipping."
            exit 0
          fi
          gh release create "${TAG}" \
            --title "git-fs ${BASE_VERSION}" \
            --notes "Stable release of git-fs ${BASE_VERSION}." \
            --target "${TARGET}" \
            assets/*

  update-homebrew:
    name: Update Homebrew formula
    needs: [promote]
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          max-depth: 1

      - uses: mesa-dot-dev/homebrew-tap-action@main
        with:
          tap: mesa-dot-dev/homebrew-tap
          tap-token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          tap-branch: staged
          template: formula.rb
          latest-path: Formula/git-fs.rb
          versioned-path: "Formula/git-fs@${VERSION}.rb"
          version: ${{ needs.promote.outputs.base_version }}
          url: "https://github.com/${{ github.repository }}/releases/download/v${{ needs.promote.outputs.base_version }}/git-fs-macos-universal.tar.gz"
          commit-message: "git-fs ${VERSION}"
          committer-name: "mesa-ci[bot]"
          committer-email: ci-bot@mesa.dev
