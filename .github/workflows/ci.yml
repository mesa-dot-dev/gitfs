name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  changes:
    name: Detect Changes
    runs-on: blacksmith-2vcpu-ubuntu-2404
    outputs:
      shell: ${{ steps.filter.outputs.shell }}
      install: ${{ steps.filter.outputs.install }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shell:
              - '**.sh'
              - '**.bash'
              - '**.zsh'
              - '**.ksh'
            install:
              - 'install.sh'

  fmt:
    name: Formatting
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt

      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libfuse3-dev
          version: 1.0

      - run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  build-and-test:
    name: Build & Test
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libfuse3-dev
          version: 1.0

      - name: Build
        run: cargo build --workspace --all-targets --all-features

      - name: Test
        run: cargo test --workspace --all-features

  python-lint:
    name: Ruff & Pyright
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --dev

      - name: Ruff check (lint)
        run: uv run ruff check .

      - name: Ruff format (formatting check)
        run: uv run ruff format --check .

      - name: Pyright (type check)
        run: uv run pyright

  integration:
    name: Integration Tests
    runs-on: blacksmith-8vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --dev

      - name: Run integration tests
        run: uv run pytest tests/ -v --log-cli-level=INFO -m integration

  shellcheck:
    name: ShellCheck
    needs: changes
    if: needs.changes.outputs.shell == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          shopt -s globstar nullglob
          shellcheck --version
          shellcheck \
            --severity=style \
            --enable=all \
            --format=gcc \
            **/*.sh **/*.bash **/*.zsh **/*.ksh

  test-install-deb:
    name: DEB 路 ${{ matrix.distro.name }}
    needs: changes
    if: needs.changes.outputs.install == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    container:
      image: ${{ matrix.distro.image }}
      options: --user root
    strategy:
      fail-fast: false
      matrix:
        distro:
          - { name: debian-12,    image: "debian:12" }
          - { name: debian-13,    image: "debian:trixie" }
          - { name: ubuntu-20.04, image: "ubuntu:20.04" }
          - { name: ubuntu-22.04, image: "ubuntu:22.04" }
          - { name: ubuntu-24.04, image: "ubuntu:24.04" }
    steps:
      - name: Install curl
        run: |
          apt-get update
          apt-get install -y curl

      - uses: actions/checkout@v4

      - name: Run install.sh -y
        run: sh install.sh -y

      - name: Verify git-fs is on PATH
        run: git-fs --version

  test-install-rpm:
    name: RPM 路 ${{ matrix.distro.name }}
    needs: changes
    if: needs.changes.outputs.install == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    container:
      image: ${{ matrix.distro.image }}
      options: --user root
    strategy:
      fail-fast: false
      matrix:
        distro:
          - { name: rocky-8,   image: "rockylinux:8" }
          - { name: rocky-9,   image: "rockylinux:9" }
          - { name: alma-8,    image: "almalinux:8" }
          - { name: alma-9,    image: "almalinux:9" }
          - { name: fedora-40, image: "fedora:40" }
          - { name: fedora-41, image: "fedora:41" }
          - { name: fedora-42, image: "fedora:42" }
          - { name: fedora-43, image: "fedora:43" }
    steps:
      - name: Install curl and git
        run: dnf install -y --allowerasing curl git

      - uses: actions/checkout@v4

      - name: Run install.sh -y
        run: sh install.sh -y

      - name: Verify git-fs is on PATH
        run: git-fs --version

  test-install-tarball:
    name: Tarball 路 archlinux
    needs: changes
    if: needs.changes.outputs.install == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    container:
      image: archlinux:latest
      options: --user root
    steps:
      - name: Install dependencies
        run: pacman -Sy --noconfirm curl git

      - uses: actions/checkout@v4

      - name: Run install.sh -y
        run: sh install.sh -y

      - name: Verify git-fs was installed
        run: test -x /usr/local/bin/git-fs

  test-install-macos:
    name: macOS 路 homebrew
    needs: changes
    if: needs.changes.outputs.install == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run install.sh
        run: sh install.sh

      - name: Verify git-fs is on PATH
        run: git-fs --version
